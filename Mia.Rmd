---
title: "OA-microbiome"
author: "Li-Fang Yeo"
date: "07 June 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(mia)
library(tidyverse)
library(dplyr)
library(knitr)
library(miaViz)
library(stringr)
library(boot)
```
Data input 
```{r}
meta <- read.csv("Metafile.csv", row.names = 1, header = TRUE)
#meta <- meta %>% mutate(Group = str_replace_all(Group,"Temiar", "A"))
tse <- importMetaPhlAn("data/42_abund_fixed.txt", assay.type = "relabundance", col.data = meta, removeTaxaPrefixes = TRUE)

#functions to make my life easier
tse_meta <- function(x, rownames = TRUE) {
  { if (inherits(x, "TreeSummarizedExperiment")) SummarizedExperiment::colData(x) else x } %>%
    { if(rownames) tibble::as_tibble(., rownames = "rownames") else tibble::as_tibble(.) }
}

tse_mutate <- function(.data, ...) {
  dots <- rlang::enquos(...)
  new_data <-  tse_meta(.data) %>%
    dplyr::mutate(!!!dots) %>%
    tibble::column_to_rownames(var = "rownames") %>%
    S4Vectors::DataFrame()
  SummarizedExperiment::colData(.data) <- new_data
  .data
}

tse <- tse %>% tse_mutate(dplyr::across(c(Group.Bi), as.factor))
```
```{r}
library(tableone)
myVars <- c("Age", "Systolic", "Diastolic", "BMI.1", "WaistCirc", "HbA1C.1",
          "H.pylori","Gender", "Smoke", "BMI", "HbA1C","Group")
## Vector of categorical variables that need transformation
catVars <- c("Gender", "Smoke", "BMI", "HbA1C","Group","H.pylori")
tableone <- CreateTableOne(vars= myVars, data = meta, strata = "Group", factorVars = catVars) 
tab <- print(tableone, quote = FALSE, noSpaces = TRUE, printToggle = FALSE)
write.csv(tab, "tableone.csv")
```

```{r}
#agglomerate data
x1 <- altExp(tse, "species")
#Top10
my_colors <- c("Jahai" = "darkgreen", "Temiar" = "skyblue", "Temuan" = "orange", "Malay" = "pink" )
plotAbundanceDensity(x1, layout = "density", assay_name = "relabundance",
                     n = 10, colour_by="Group", point_alpha=0.5) + scale_x_log10(label = scales::label_number()) +
  scale_fill_manual(values = my_colors)
```
```{r}
#Abundance
plotAbundanceDensity(x1, layout = "jitter", assay.type = "relabundance",
                     n = 20, point_size=1, point_shape=19, point_alpha=0.1, order_descending = TRUE) +
  scale_x_log10(label = scales::percent)
```
Alpha diversity 
```{r}
library(scater)
library(patchwork)
library(ggsignif)
x1 <- mia::estimateDiversity(x1, 
                              assay.type = "relabundance",
                              index = "shannon", 
                              name = "shannon", )
df<- as.data.frame(colData(x1))
#change level
df$Group <- factor(df$Group, levels = c("Jahai", "Temiar", "Temuan", "Malay"))
# For significance testing, all different combinations are determined
comb <- split(t(combn(levels(df$Group), 2)), 
           seq(nrow(t(combn(levels(df$Group), 2)))))

pdf("alpha.pdf")
ggplot(df, aes(x = Group, y = shannon, fill = Group)) +
  # Outliers are removed, because otherwise each 
  # data point would be plotted twice; 
  # as an outlier of boxplot and as a point of dotplot.
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = 0.2) + 
  geom_signif(comparisons = comb, map_signif_level = FALSE,
              correction="fdr", step_increase = 0.1) + #Corrects the p-values and step increase minimise overlap
  theme(text = element_text(size = 6)) + theme_classic() +
  scale_fill_manual(values = my_colors)
alpha

```
Beta diversity
```{r}
x1 <- runRDA(x1,
               assay.type = "relabundance",
               formula = assay ~ Group,
               distance = "bray",
               na.action = na.exclude)

x1 <- addRDA(x1,
               assay.type = "relabundance",
               formula = assay ~ Group,
               distance = "bray",
               na.action = na.exclude)
# Store results of PERMANOVA test
rda_info <- attr(reducedDim(x1, "RDA"), "significance")
```
```{r}
rda_info$permanova |>
  knitr::kable()
```
```{r}
rda_info$homogeneity |>
  knitr::kable()
```
```{r}
#dbRDA plot
p <- plotRDA(x1, "RDA", add.ellipse = TRUE, color_by = "Group") +
  scale_color_manual(values = my_colors, name = "Groups",
  breaks = c("Jahai", "Temiar", "Temuan", "Malay")) +
  theme_classic() 
ggsave("RDA.pdf",
       p, 
       width = 8,
       height = 6,
       units = "in")
```
```{r}
#plot dbRDA loadings
L<- miaViz::plotLoadings(x1, "RDA", ncomponents = 2, n = 10)

library(patchwork)
onni <- p / L
ggsave("RDA-loadings.pdf",
       onni, 
       width = 8,
       height = 8,
       units = "in")
```

Differential abundance analysis
```{r}
# Load package
library(ANCOMBC)
# ANCOM-BC2
tse_species_BC <- mia::subsetByPrevalentFeatures(tse, rank = "species",
                                              detection = 0.1/100,
                                              prevalence = 5/100,
                                              as_relative = TRUE,
                                              assay.type = "relabundance")
```
```{r}
pcol <- glue::glue("q_Group.Bi")
```
```{r}
ancombc2_species <- ANCOMBC::ancombc2(data = tse_species_BC,
            fix_formula = "Group.Bi",
                         assay_name = "relabundance",
                         p_adj_method = "BH",
                         verbose = TRUE,
                         neg_lb = TRUE,
            mdfdr_control = list(fwer_ctrl_method = "BH", B = 100))
```
```{r}
df <- ancombc2_species$res %>%
  dplyr::select(taxon, contains("Group.Bi"))
```
```{r}
df %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  #select(taxon, contains("Temiar")) %>%
  filter(if_any(contains("q_"), ~ . < 0.05)) %>%
  DT::datatable(caption = "Group") 
  write.csv("./ancom-group.bi.csv")
```
Linear model
```{r}
subset_features_partial <-  purrr::partial(mia::agglomerateByPrevalence,
                                           x = tse_species_BC,
                                           detection = 0.1/100,
                                           prevalence = 5/100,
                                           assay.type = "relabundance") %>%
  purrr::possibly()

taxa_subsets <- c("species") %>%
  rlang::set_names() %>%
  purrr::map(subset_features_partial)

melt_tse <- function(x, method = "clr") {
    mia::transformAssay(x, assay.type = "relabundance", method = method, pseudocount = 1) %>% 
    mia::meltSE(add_row_data = TRUE, assay.type = method) %>%
    dplyr::mutate(FeatureID = glue::glue("GUT_{FeatureID}")) %>%
    dplyr::select(SampleID, FeatureID, clr) %>%
    tidyr::spread(FeatureID, clr) %>% 
    dplyr::full_join(tse_meta(x), by = dplyr::join_by(SampleID == rownames))
}

dfs <- taxa_subsets %>%
  purrr::map(melt_tse, .progress = TRUE)


lm_group_partial <- purrr::partial(lm, formula = Group.Bi ~ term) %>%
                    purrr::possibly()

lm_group_model_for_taxon <- function(df, term, rank = NULL) {
 message(term)
 data <- if (is.null(rank)) df else df[[rank]]
 data <- data %>% dplyr::rename(term := {{term}})
 lm_group_partial(data = data)
}

# Step 4: Extract taxa names and run models
taxa_rank_list <- dfs %>%
 purrr::imap(~ colnames(.x) %>% stringr::str_subset("GUT_") %>% rlang::set_names())

df_lm_group_results <- taxa_rank_list %>%
 purrr::map_df(~tibble::tibble(taxa = .x), .id = "rank") %>% 
  tidyr::gather(rank, taxa) %>%
  dplyr::mutate(results = purrr::map2(rank, taxa, ~lm_group_model_for_taxon(df = dfs, term = .y, rank = .x))) %>%
  dplyr::mutate(results = purrr::map(results, ~broom::tidy(.x, conf.int = TRUE)))  %>%
  tidyr::unnest(results) %>%
  dplyr::filter(stringr::str_detect(term, "term")) %>%
  dplyr::mutate(qval_fdr = p.adjust(p.value, method = "BH")) %>%
  dplyr::filter(qval_fdr < 0.1)

# Step 5: Display results
df_glm_group_results %>%
  dplyr::arrange(qval_fdr) %>%
  dplyr::mutate_if(is.numeric, ~round(.x, digits = 4)) %>%
  #write.csv("df_lm.Group.BI.csv", col.names = TRUE)
  DT::datatable(caption = "Linear model for Urban vs Rural")
```






